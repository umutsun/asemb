# Codex Deployment Commands for luwi.dev

commands:
  deploy:
    luwi:
      description: "Deploy ASB to luwi.dev server"
      steps:
        - name: "Build Project"
          command: "npm run build"
          timeout: 60000
        
        - name: "Run Tests"
          command: "npm test"
          continueOnError: true
        
        - name: "Create Deploy Package"
          shell: "powershell"
          script: |
            Remove-Item -Path deploy-package -Recurse -Force -ErrorAction SilentlyContinue
            New-Item -ItemType Directory -Path deploy-package -Force
            
            Copy-Item -Path dist -Destination deploy-package/ -Recurse
            Copy-Item -Path api -Destination deploy-package/ -Recurse
            Copy-Item -Path dashboard -Destination deploy-package/ -Recurse
            Copy-Item -Path scripts -Destination deploy-package/ -Recurse
            Copy-Item -Path package*.json -Destination deploy-package/
            Copy-Item -Path .env.luwi -Destination deploy-package/.env
            
            Compress-Archive -Path deploy-package/* -DestinationPath asb-deploy.zip -Force
        
        - name: "Transfer to Server"
          command: "scp asb-deploy.zip root@91.99.229.96:/tmp/"
          requiresConfirmation: true
        
        - name: "Deploy on Server"
          command: "ssh root@91.99.229.96 'cd /opt && rm -rf alice-semantic-bridge && mkdir alice-semantic-bridge && cd alice-semantic-bridge && unzip /tmp/asb-deploy.zip && npm install --production && systemctl restart asb-api'"
          requiresConfirmation: true

  test:
    remote:
      description: "Test remote deployment"
      steps:
        - name: "Check API Health"
          command: "curl http://91.99.229.96:3000/api/v1/health"
        
        - name: "Check n8n Connection"
          command: "curl -I https://n8n.luwi.dev"
        
        - name: "Check Database"
          shell: "powershell"
          script: |
            $env:PGPASSWORD = $env:POSTGRES_PASSWORD
            psql -h 91.99.229.96 -U asemb_user -d asemb -c "SELECT version();"

  sync:
    redis:
      description: "Sync Redis data with remote server"
      steps:
        - name: "Export Local Redis"
          command: "redis-cli -n 2 --rdb dump.rdb"
        
        - name: "Transfer to Server"
          command: "scp dump.rdb root@91.99.229.96:/tmp/"
        
        - name: "Import on Server"
          command: "ssh root@91.99.229.96 'redis-cli -a $REDIS_PASSWORD --rdb /tmp/dump.rdb'"

  logs:
    luwi:
      description: "View logs from luwi.dev server"
      steps:
        - name: "API Logs"
          command: "ssh root@91.99.229.96 'tail -f /opt/alice-semantic-bridge/logs/api.log'"
          interactive: true
        
        - name: "Error Logs"
          command: "ssh root@91.99.229.96 'tail -f /opt/alice-semantic-bridge/logs/error.log'"
          interactive: true

  backup:
    luwi:
      description: "Backup luwi.dev deployment"
      steps:
        - name: "Create Remote Backup"
          command: "ssh root@91.99.229.96 '/opt/backup-asb.sh'"
        
        - name: "Download Backup"
          shell: "powershell"
          script: |
            $date = Get-Date -Format "yyyyMMdd_HHmmss"
            $backupDir = "backups/luwi_$date"
            New-Item -ItemType Directory -Path $backupDir -Force
            
            scp root@91.99.229.96:/opt/backups/asemb_*.sql $backupDir/
            scp root@91.99.229.96:/opt/backups/redis_*.rdb $backupDir/

aliases:
  dl: "deploy luwi"
  tl: "test remote"
  ll: "logs luwi"
  bl: "backup luwi"